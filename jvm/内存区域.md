# JVM虚拟机

## 内存区域

### 运行时数据区域

![截屏2023-10-01 08.36.29](/Users/moon/Desktop/截屏2023-10-01 08.36.29.png)

- 程序计数器
  - 当前线程所执行字节码的行号指示器
  - 线程私有
  - 没有规定OutOfMemoryError情况
- Java虚拟机栈
  - 线程私有，生命周期和线程相同
  -  Java方法执行的线程内存模型：每个方法被执行的时候，Java虚拟机都会同步创建一个栈帧用于存储局部变量表 操作数栈 动态链接 方法出口等信息。
  - 局部变量表：存储基本数据类型（boolean，int，shot，long，float，double，byte，char），对象引用（reference类型：指向对象起始地址引用指针 或 对象句柄 或 其他与此对象相关位置 ）和returnAddress类型（字节码指令地址）。以局部变量槽表示。
  - 线程请求栈深度超过虚拟机允许深度：StackOverflowError，虚拟机栈可以动态扩展时，当栈扩展无法申请足够内存时：OutOfMemoryError。
- 本地方法栈
  - 为虚拟机使用到的本地方法服务。
  - 栈深度溢出：StackOverflowError，栈扩展失败：OutOfMemeoryError。
- Java堆
  - 所有线程共享的一块内存区域，存放对象实例。
  - 垃圾收集管理器的内存区域
  - Java堆没有内存完成实例分配，且无法扩展时：OutOfMemoryError。
- 方法区
  - 线程共享的内存区域，存储已被虚拟机加载的内存信息 常量 静态变量 即使编译器编译后的代码缓存等信息。
  - 无法满足新内存分配需求时：OutOfMemoryError。
- 运行时常量池
  - 方法区的一部分
  - 常量池表：用于存储编译器生成的各种字面量与符号引用
- 直接内存
  - 非运行时数据区域一部分
  - OutOfMemoryError


### HotSpot虚拟机对象

- 对象创建

  - 指针碰撞：把指针向空闲空间方向移动一段与对象大小相等的距离。
  - 空闲列表：虚拟机维护一个列表，记录哪些内存块可用。再分配时，从列表中找到一块足够大的空间分给对象实例，并更新列表上记录。

- 对象内存布局

  - 对象头，实例数据，对象填充

  - 对象头：

    - 第一类存储对象自身运行时数据（哈希码，GC分代年龄，锁状态标识，线程持有的锁，偏向线程ID，偏向时间戳），32位虚拟机（32比特）64位虚拟机（64比特）

    ![截屏2023-10-01 11.34.33](/Users/moon/Desktop/截屏2023-10-01 11.34.33.png)

    - 第二类类型指针，即对象指向它类型元数据的指针，可以用来确认该对象时那个类的实例。

- 对象的访问定位

  - 通过栈上的refrence数据来操作堆上的具体对象。
  - 访问方式：
    - 句柄访问：Java堆划分出一块内存地址作为句柄池，reference中存储对象句柄地址，句柄中包含对象实例数据和类型数据各自地址信息。
    - 直接指针访问：Java堆中对象内存布局需考虑如何放置访问类型数据信息，reference中直接存储对象地址。

  ![截屏2023-10-01 14.35.16 1](/Users/moon/Desktop/截屏2023-10-01 14.35.16 1.png)
